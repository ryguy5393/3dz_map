<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3-Digit ZIP Code Mapper</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background-color: black;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #container {
      position: relative;
      width: 90%;
      height: 90%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 5;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      width: 300px;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .infoBox {
      margin-top: 10px;
      font-size: 14px;
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 3px;
      background: #f9f9f9;
      color: black;
    }
    button, select {
      margin-top: 10px;
      width: 100%;
    }
    .legend {
      font-size: 13px;
      margin-top: 10px;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 5px;
    }
    #carrierDataTable {
      display: none;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="map"></div>
</div>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Enter 3-digit ZIP(s), e.g., 902, 303, 606">
  <select id="carrierSelect" multiple size="6">
    <option value="veterans">Veteran's</option>
  </select>
  <button id="clearButton">Clear All Selections</button>
  <button id="beginProfileButton">Create Carrier Profile</button>
  <select id="roleSelector">
    <option value="pickup">Pickup</option>
    <option value="deliver">Deliver</option>
    <option value="both">Both</option>
  </select>
  <button id="finalizeProfileButton" style="display:none;">Finalize & Save Profile</button>
  <input id="profileName" type="text" placeholder="Enter profile name" style="display:none;">

  <div class="legend">
    <b>Legend:</b><br>
    <span style="background-color: green;"></span> Pickup<br>
    <span style="background-color: blue;"></span> Deliver<br>
    <span style="background-color: purple;"></span> Both<br>
    <span style="background-color: red;"></span> Manual (toggle)<br>
  </div>

  <div id="manualSelectionBox" class="infoBox"><b>Selected ZIPs:</b> None</div>
  <div id="carrierSelectionBox" class="infoBox"><b>Carrier ZIPs:</b> None</div>
</div>

<script>
  let map;
  let selectedZips = new Map();
  let pickupZips = new Set();
  let deliverZips = new Set();
  let overlappingZips = new Set();
  let currentCarrier = null;
  let profileMode = false;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 4,
      center: { lat: 39.8283, lng: -98.5795 },
      mapTypeControl: true,
      fullscreenControl: true,
    });

    map.data.loadGeoJson('https://raw.githubusercontent.com/ryguy5393/3dz_map/main/3_digit_zip_boundaries.geojson');

    map.data.setStyle({
      fillColor: 'blue',
      fillOpacity: 0.1,
      strokeColor: 'black',
      strokeWeight: 1,
    });

    map.data.addListener("click", event => {
      const zipCode = event.feature.getProperty("ZIP3").toString();
      if (profileMode) {
        const role = document.getElementById("roleSelector").value;
        selectedZips.set(zipCode, role);
        map.data.overrideStyle(event.feature, {
          fillColor: role === "pickup" ? 'green' : role === "deliver" ? 'blue' : 'purple',
          fillOpacity: 0.6
        });
      } else {
        if (selectedZips.has(zipCode)) {
          selectedZips.delete(zipCode);
          map.data.overrideStyle(event.feature, null);
        } else {
          selectedZips.set(zipCode, "manual");
          map.data.overrideStyle(event.feature, { fillColor: 'red', fillOpacity: 0.6 });
        }
      }
      updateManualInfo();
    });

    document.getElementById("searchBox").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        const zipInput = this.value.trim();
        if (zipInput) {
          const zips = zipInput.split(',').map(z => z.trim());
          map.data.forEach(feature => {
            const zip = feature.getProperty("ZIP3").toString();
            if (zips.includes(zip)) {
              const role = profileMode ? document.getElementById("roleSelector").value : "manual";
              selectedZips.set(zip, role);
              map.data.overrideStyle(feature, {
                fillColor: role === "pickup" ? 'green' : role === "deliver" ? 'blue' : role === "both" ? 'purple' : 'red',
                fillOpacity: 0.6
              });
            }
          });
          updateManualInfo();
        }
      }
    });

    document.getElementById("beginProfileButton").addEventListener("click", () => {
      profileMode = true;
      document.getElementById("finalizeProfileButton").style.display = "block";
      document.getElementById("profileName").style.display = "block";
    });

    document.getElementById("finalizeProfileButton").addEventListener("click", () => {
      const profileName = document.getElementById("profileName").value.trim();
      if (!profileName) return alert("Enter a name for this profile.");
      if (selectedZips.size === 0) return alert("No ZIPs selected.");
      const profileData = {};
      selectedZips.forEach((role, zip) => profileData[zip] = role);
      localStorage.setItem(`zipProfile_${profileName}`, JSON.stringify(profileData));
      alert(`Saved profile "${profileName}"`);
      addProfileToDropdown(profileName);
      document.getElementById("profileName").value = "";
      document.getElementById("finalizeProfileButton").style.display = "none";
      document.getElementById("profileName").style.display = "none";
      profileMode = false;
    });

    document.getElementById("clearButton").addEventListener("click", clearAllSelections);

    document.getElementById("carrierSelect").addEventListener("change", function () {
      const selected = Array.from(this.selectedOptions).map(opt => opt.value);
      map.data.revertStyle();
      selected.forEach(value => {
        if (value === "veterans") {
          currentCarrier = "veterans";
          loadCarrierData();
          highlightCarrierZips();
        } else {
          const stored = localStorage.getItem(`zipProfile_${value}`);
          if (!stored) return;
          const profileData = JSON.parse(stored);
          map.data.forEach(feature => {
            const zip = feature.getProperty("ZIP3").toString();
            const role = profileData[zip];
            if (role) {
              map.data.overrideStyle(feature, {
                fillColor: role === "pickup" ? 'green' : role === "deliver" ? 'blue' : role === "both" ? 'purple' : 'orange',
                fillOpacity: 0.6
              });
            }
          });
        }
      });
      updateCarrierInfo();
    });

    loadCarrierData();
    updateCustomProfileDropdown();
  }

  function addProfileToDropdown(name) {
    const carrierSelect = document.getElementById("carrierSelect");
    const exists = Array.from(carrierSelect.options).some(opt => opt.value === name);
    if (!exists) {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      carrierSelect.appendChild(option);
    }
  }

  function updateCustomProfileDropdown() {
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith("zipProfile_")) {
        const name = key.replace("zipProfile_", "");
        addProfileToDropdown(name);
      }
    });
  }

  function updateManualInfo() {
    const display = Array.from(selectedZips.entries()).map(([zip, role]) => `${zip} (${role})`);
    document.getElementById("manualSelectionBox").innerHTML = `<b>Selected ZIPs:</b> ${display.length ? display.join(", ") : "None"}`;
  }

  function clearAllSelections() {
    selectedZips.clear();
    pickupZips.clear();
    deliverZips.clear();
    overlappingZips.clear();
    currentCarrier = null;
    profileMode = false;
    map.data.revertStyle();
    document.getElementById("carrierSelect").selectedIndex = -1;
    updateManualInfo();
    updateCarrierInfo();
  }

  function loadCarrierData() {
    pickupZips.clear();
    deliverZips.clear();
    overlappingZips.clear();
    document.querySelectorAll("#carrierDataTable tbody tr").forEach(row => {
      const pickupZip = row.cells[0].textContent.trim();
      const deliverZip = row.cells[1].textContent.trim();
      pickupZips.add(pickupZip);
      deliverZips.add(deliverZip);
      if (pickupZip === deliverZip) overlappingZips.add(pickupZip);
    });
  }

  function highlightCarrierZips() {
    map.data.forEach(feature => {
      const zip = feature.getProperty("ZIP3").toString();
      let style = { fillColor: 'blue', fillOpacity: 0.1 };
      if (overlappingZips.has(zip)) {
        style.fillColor = 'purple';
        style.fillOpacity = 0.6;
      } else if (pickupZips.has(zip)) {
        style.fillColor = 'green';
        style.fillOpacity = 0.4;
      } else if (deliverZips.has(zip)) {
        style.fillColor = 'blue';
        style.fillOpacity = 0.4;
      }
      map.data.overrideStyle(feature, style);
    });
  }

  function updateCarrierInfo() {
    let carrierZipList = [];
    pickupZips.forEach(zip => {
      if (deliverZips.has(zip)) {
        carrierZipList.push(`${zip} (Both)`);
      } else {
        carrierZipList.push(`${zip} (Pickup)`);
      }
    });
    deliverZips.forEach(zip => {
      if (!pickupZips.has(zip)) {
        carrierZipList.push(`${zip} (Deliver)`);
      }
    });
    document.getElementById("carrierSelectionBox").innerHTML = `<b>Carrier ZIPs:</b> ${carrierZipList.length ? carrierZipList.join(", ") : "None"}`;
  }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCSSpdMxUsQ_vuz80UNmA8p9BaBpdceQsQ&callback=initMap" async defer></script>
</body>
</html>
